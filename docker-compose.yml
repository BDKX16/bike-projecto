version: '3.8'

services:
  # Backend API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: bike-api
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "3120:3001"
    environment:
      NODE_ENV: production
      API_PORT: 3001
      # MongoDB - Configurar según tu setup existente
      MONGO_USERNAME: ${MONGO_USERNAME:-admin}
      MONGO_PASSWORD: ${MONGO_PASSWORD}
      MONGO_HOST: ${MONGO_HOST:-mongo}
      MONGO_PORT: ${MONGO_PORT:-27017}
      MONGO_DATABASE: ${MONGO_DATABASE:-bike_projecto}
      # Email - Gmail o SMTP personalizado
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      ALERT_EMAIL: ${ALERT_EMAIL:-xgalarreta.dev@gmail.com}
      # SMTP personalizado (opcional, comentar si usas Gmail)
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_SECURE: ${SMTP_SECURE:-false}
    networks:
      - default
      - shared-network  # Red externa donde está MongoDB
    volumes:
      - ./api/logs:/app/logs

  # Frontend Next.js
  frontend:
    build:
      context: ./bike-projecto
      dockerfile: Dockerfile
    container_name: bike-frontend
    restart: unless-stopped
    ports:
      - "3121:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://bike.xaviergalarreta.pro/api}
    depends_on:
      - api
    # Usa la red por defecto (no es necesario declarar)

networks:
  shared-network:
    external: true
    name: shared-network
